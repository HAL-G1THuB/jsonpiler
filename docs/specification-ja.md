# 仕様

Jsonpiler 言語の仕様。

## 構文

構文は JSON 仕様に基づいています。
参照: [JSON 仕様 (RFC 8259)](https://www.rfc-editor.org/info/rfc8259)

## 型

### プリミティブ型

- **Null**：値の欠如を表します。概念としてはUnit値に近い。
- **Bool**：8 ビットのブール値。`true` または `false`。
- **Int**：64 ビットの整数値。
- **Float**：64 ビットの浮動小数点数。
- **String**：ダブルクオートで囲まれた文字列。

### 複合型

- **Array**：順序付きの値の集合を表します。

#### Object のサブタイプ

- **HashMap**：キーと値のペアの集合。

```json
{ "key": "value" }
```

- **Block**：命令の順序付き列。

```json
{
  "message": ["123", "456"],
  "+": [1, 2]
}
```

- **TypeAnnotations**：変数や関数に対する型注釈を表す。

```json
{
  "i": "Int",
  "x": "String",
  "return": "String"
}
```

## 評価（Evaluation）

Jsonpiler プログラムは、単一の JSON 値として表現されます。

各 JSON 値は独立して評価されますが、配列（`[]`）やオブジェクト（`{}`）の場合は例外です。

### 配列

- 配列内の各要素は順に評価されます。
- 結果は、評価済みの要素を順序を保って格納した新しい配列になります。

```json
[1, { "+": [2, 3] }, "text"]
// => [1, 5, "text"]
```

### オブジェクト

- オブジェクトの各キーは関数名として解釈されます。
- 各値は評価され、関数の引数として渡されます。
- キーが登録済みの組み込み関数に一致する場合はそれを使用し、それ以外はユーザー定義関数が検索されます。
- 複数のキー・関数エントリがサポートされており、挿入順に評価されます。
- 最後に呼び出された関数の戻り値が最終的な評価結果として返されます。

```json
{
  "message": ["123", "456"],
  "+": [1, 2]
}
// => "message" を評価し、その後 "+" を評価。"+" の結果を返す
```

## 終了コード（Exits）

プログラム全体がIntに評価された場合は、それを終了コードとして返します。
jsonpiler が返す終了コードは生成した.exeファイルの終了コードである32bit符号付き整数です。
コンパイルエラーが発生した場合、または実行ファイルが生成されなかった場合は、終了コードは 1 になります。

## 文字エンコーディング

このプログラムは UTF-8 をサポートします。

## JSPL 言語仕様

### 概要

この言語は、JSON をベースとした構造に、軽量な構文糖と関数呼び出しや識別子による拡張を加えた形式です。
トップレベルで `{}` に囲まれていないブロック形式 (`JSPL`) の構文も許容されます。

### トップレベルの構文

- 通常の JSON 形式 (`parse_json`) に加えて、より柔軟な構文 (`parse_block`) をサポート
- JSPL 構文では、トップレベルで `{}` を省略可能
- 変数呼び出しや識別子に関数風の構文 `(arg1, arg2)` を組み合わせることができる

---

### 構文詳細

#### 値（value）

任意の値は以下のいずれか：

- 文字列：`"abc"`
- 数値：`123`, `-10`, `1.23`, `2e5`
- ブール値：`true`, `false`
- null：`null`
- 配列：`[ val1, val2, ... ]`
- オブジェクト：`{ "key": value, ... }`
- 特殊構文：

  - 識別子：`someIdent` → `"someIdent"`
  - 識別子関数：`someFunc(arg1, arg2)` → `{ "someFunc": [ arg1, arg2 ] }`
  - プレーン識別子：`$name` → `{ "$": "name" }`
  - 値のペア：`val1 ident val2` → `{ ident: [ val1, val2 ] }`

---

### 数値（number）

- 数値は整数か浮動小数点数
- 負号 `-` を先頭に付けることができる
- `+` は **許容されない**
- 整数部の先頭に `0` が付くのは **禁止**（例：`0123` → エラー）
- 浮動小数点形式 `123.45` や指数形式 `1.23e+10` をサポート

  - `e` または `E` に続く `+/-` と数字の並びが必須

#### 数値の構文（BNF）

```text
number ::= '-'? int ('.' [0-9]+)? ([eE] [+-]? [0-9]+)?
int    ::= '0' | [1-9][0-9]*
```

---

### 識別子（identifier）

- `!`〜`~`（0x21〜0x7E）の ASCII 印字可能文字のうち、以下を除く記号が使用可能：

  - `(`, `)`, `[`, `]`, `{`, `}`, `,`, `"`, `:`, `;`

- 次の語は **予約語として識別子に使用不可**：

  - `true`, `false`, `null`
  - `$` で始まる名前（例：`$name`）は予約された意味を持つ

---

内部的には String の省略表現として扱われる。

### 文字列（string）

- 二重引用符 `"..."` で囲まれた UTF-8 文字列
- バックスラッシュによるエスケープ文字をサポート：

| シーケンス | 意味                                          |
| ---------- | --------------------------------------------- |
| `\"`       | ダブルクオート                                |
| `\\`       | バックスラッシュ                              |
| `\/`       | スラッシュ                                    |
| `\b`       | バックスペース                                |
| `\f`       | フォームフィード                              |
| `\n`       | 改行                                          |
| `\r`       | 復帰                                          |
| `\t`       | タブ                                          |
| `\uXXXX`   | 16 進ユニコードコードポイント（UTF-8 へ変換） |

- 改行や制御文字は未エスケープでは **許容されない**

---

### 配列（array）

```json
["item1", 42, { "key": "value" }]
```

- `[]` で囲まれた値の列
- 値の区切りに `,` を使用
- 空配列 `[]` も許容される

---

### オブジェクト（object）

```jspl
key1(value1)
key2(42)
```

```jspl
{ key1: value1, key2: 42 }
```

- キーは文字列または識別子でなければならない。
- 空のオブジェクト`{}`は関数列として評価される場合は基本的に許容されない。

---

### JSPL 拡張構文

#### トップレベルブロックの `{}` 省略

```jspl
key: "value"
list: [1, 2, 3]
```

→ JSON 相当：

```json
{ "key": "value", "list": [1, 2, 3] }
```

### オブジェクト内1行中に複数の要素

```jspl
key1: "value"; key2: 42
```

→

```json
{ "key1": "value", "key2": 42 }
```

#### 中置記法 (どの関数にも適用可能)

```jspl
1 + 20 + 300
```

→

```json
{ "+": [1, 20, 300] }
```

#### 識別子関数構文

```jspl
sum(1, 2, 3)
```

→

```json
{ "sum": [1, 2, 3] }
```

```jspl
abs: -1
```

→

```json
{ "abs": -1 }
```

#### `$name` 記法

```jspl
$name;
```

→

```json
{ "$": "name" }
```

---

#### コメント

```jspl
# comment
```

### エラールール（Parser）

- 不正な文字列エスケープ → エラー
- 制御文字を含む文字列 → エラー
- `0` で始まる複数桁の整数 → エラー
- `.` の後に数字がない浮動小数点 → エラー
- `e`/`E` の後に数字がない指数 → エラー
- キーが文字列以外 → エラー
- 不正なトップレベル入力の残存 → `Unexpected trailing characters`

---
